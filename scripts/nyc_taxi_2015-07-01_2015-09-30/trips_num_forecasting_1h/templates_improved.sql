WITH {hourstamp} AS target_hourstamp, dateAdd(HOUR, target_hourstamp - 24, toDate('2015-01-01')) AS target_date SELECT toDayOfYear(target_date) AS day_of_year, target_hourstamp % 24 AS hour_of_day, hour_of_day BETWEEN 17 AND 19 AS is_evening ;
WITH (toDayOfYear(pickup_datetime) * 24 + toHour(pickup_datetime) ) AS pickup_hourstamp, (toDayOfYear(dropoff_datetime) * 24 + toHour(dropoff_datetime) ) AS dropoff_hourstamp, {hourstamp} AS target_hourstamp, pickup_hourstamp BETWEEN target_hourstamp - 1 AND target_hourstamp - 1 AS departed, dropoff_hourstamp BETWEEN target_hourstamp - 1 AND target_hourstamp - 1 AS finished SELECT count() AS count_departure_1h, sum(trip_distance) AS sum_trip_distance_1h, sum(tip_amount) AS sum_tip_amount_1h, avgIf(fare_amount, finished) AS avg_fare_amount_finished_1h FROM trips WHERE departed;
WITH (toDayOfYear(pickup_datetime) * 24 + toHour(pickup_datetime) ) AS pickup_hourstamp, (toDayOfYear(dropoff_datetime) * 24 + toHour(dropoff_datetime) ) AS dropoff_hourstamp, {hourstamp} AS target_hourstamp, pickup_hourstamp BETWEEN target_hourstamp - 24 AND target_hourstamp - 1 AS departed, dropoff_hourstamp BETWEEN target_hourstamp - 24 AND target_hourstamp - 1 AS finished SELECT avg(trip_duration) AS avg_trip_duration_24h FROM trips WHERE departed;
WITH (toDayOfYear(pickup_datetime) * 24 + toHour(pickup_datetime) ) AS pickup_hourstamp, (toDayOfYear(dropoff_datetime) * 24 + toHour(dropoff_datetime) ) AS dropoff_hourstamp, {hourstamp} AS target_hourstamp, pickup_hourstamp BETWEEN target_hourstamp - 24 AND target_hourstamp - 24 AS departed, dropoff_hourstamp BETWEEN target_hourstamp - 24 AND target_hourstamp - 24 AS finished SELECT avgIf(tip_amount, finished) AS avg_tip_amount_finished_yesterday_1h FROM trips WHERE departed;
WITH (toDayOfYear(pickup_datetime) * 24 + toHour(pickup_datetime) ) AS pickup_hourstamp, (toDayOfYear(dropoff_datetime) * 24 + toHour(dropoff_datetime) ) AS dropoff_hourstamp, {hourstamp} AS target_hourstamp, pickup_hourstamp BETWEEN target_hourstamp - 24 * 7 AND target_hourstamp - 24 * 7 AS departed, dropoff_hourstamp BETWEEN target_hourstamp - 24 * 7 AND target_hourstamp - 24 * 7 AS finished SELECT max(tip_amount) AS max_tip_amount_last_week_1h FROM trips WHERE departed